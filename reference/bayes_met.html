<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Bayesian model for multi-environment trials — bayes_met • ProbBreed</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Bayesian model for multi-environment trials — bayes_met"><meta name="description" content="Fits a Bayesian multi-environment model using rstan, the R interface to Stan."><meta property="og:description" content="Fits a Bayesian multi-environment model using rstan, the R interface to Stan."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ProbBreed</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.4.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/saulo-chaves/ProbBreed/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Bayesian model for multi-environment trials</h1>
      <small class="dont-index">Source: <a href="https://github.com/saulo-chaves/ProbBreed/blob/main/R/bayes_met.R" class="external-link"><code>R/bayes_met.R</code></a></small>
      <div class="d-none name"><code>bayes_met.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Fits a Bayesian multi-environment model using <code>rstan</code>, the <code>R</code> interface to <code>Stan</code>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">bayes_met</span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  <span class="va">gen</span>,</span>
<span>  <span class="va">loc</span>,</span>
<span>  <span class="va">repl</span>,</span>
<span>  <span class="va">trait</span>,</span>
<span>  reg <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  year <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  res.het <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  pars <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  warmup <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">iter</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  thin <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  seed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="va">.Machine</span><span class="op">$</span><span class="va">integer.max</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  init <span class="op">=</span> <span class="st">"random"</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  algorithm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"NUTS"</span>, <span class="st">"HMC"</span>, <span class="st">"Fixed_param"</span><span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  include <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  show_messages <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-data">data<a class="anchor" aria-label="anchor" href="#arg-data"></a></dt>
<dd><p>A data frame in which to interpret the variables declared in the other arguments.</p></dd>


<dt id="arg-gen-loc">gen, loc<a class="anchor" aria-label="anchor" href="#arg-gen-loc"></a></dt>
<dd><p>A string. The name of the columns that contain the evaluated
candidates and locations (or environments, if you are working with factor combinations), respectively.</p></dd>


<dt id="arg-repl">repl<a class="anchor" aria-label="anchor" href="#arg-repl"></a></dt>
<dd><p>A string, a vector, or <code>NULL</code>. If the trial is randomized in complete blocks design,
<code>repl</code> will be a string representing the name of the column that corresponds to the blocks.
If the trial is randomized in incomplete blocks design, <code>repl</code> will be a string vector
containing the name of the columns that correspond to the replicate and block effects on
the first and second positions, respectively (<code>c(replicate, block)</code>).
If the data does not have replicates, <code>repl</code> must be <code>NULL</code>.</p></dd>


<dt id="arg-trait">trait<a class="anchor" aria-label="anchor" href="#arg-trait"></a></dt>
<dd><p>A string. The analysed variable. Currently, only single-trait models are fitted.</p></dd>


<dt id="arg-reg">reg<a class="anchor" aria-label="anchor" href="#arg-reg"></a></dt>
<dd><p>A string or NULL. The name of the column that contain information on
regions or mega-environments. <code>NULL</code> (default) if not applicable.</p></dd>


<dt id="arg-year">year<a class="anchor" aria-label="anchor" href="#arg-year"></a></dt>
<dd><p>A string or NULL. The name of the column that contain information on
years (or seasons). <code>NULL</code> (default) if not applicable.</p></dd>


<dt id="arg-res-het">res.het<a class="anchor" aria-label="anchor" href="#arg-res-het"></a></dt>
<dd><p>Should the model consider heterogeneous residual variances?
Defaults for <code>FALSE</code>. If <code>TRUE</code>, the model will estimate one
residual variance per location (or environmnet).</p></dd>


<dt id="arg-iter">iter<a class="anchor" aria-label="anchor" href="#arg-iter"></a></dt>
<dd><p>A positive integer specifying the number of iterations for each
    chain (including warmup). The default is 2000.</p></dd>


<dt id="arg-cores">cores<a class="anchor" aria-label="anchor" href="#arg-cores"></a></dt>
<dd><p>Number of cores to use when executing the chains in parallel,
    which defaults to 1 but we recommend setting the <code>mc.cores</code> option
    to be as many processors as the hardware and RAM allow (up to the
    number of chains).</p></dd>


<dt id="arg-chains">chains<a class="anchor" aria-label="anchor" href="#arg-chains"></a></dt>
<dd><p>A positive integer specifying the number of Markov chains.
    The default is 4.</p></dd>


<dt id="arg-pars">pars<a class="anchor" aria-label="anchor" href="#arg-pars"></a></dt>
<dd><p>A vector of character strings specifying parameters of interest.
    The default is <code>NA</code> indicating all parameters in the model.
    If <code>include = TRUE</code>, only samples for parameters named in <code>pars</code>
    are stored in the fitted results. Conversely, if <code>include = FALSE</code>,
    samples for all parameters <em>except</em> those named in <code>pars</code> are
    stored in the fitted results.</p></dd>


<dt id="arg-warmup">warmup<a class="anchor" aria-label="anchor" href="#arg-warmup"></a></dt>
<dd><p>A positive integer specifying the number of warmup (aka burnin)
    iterations per chain. If step-size adaptation is on (which it is by default),
    this also controls the number of iterations for which adaptation is run (and
    hence these warmup samples should not be used for inference). The number of
    warmup iterations should be smaller than <code>iter</code> and the default is
    <code>iter/2</code>.</p></dd>


<dt id="arg-thin">thin<a class="anchor" aria-label="anchor" href="#arg-thin"></a></dt>
<dd><p>A positive integer specifying the period for saving samples.
    The default is 1, which is usually the recommended value.</p></dd>


<dt id="arg-seed">seed<a class="anchor" aria-label="anchor" href="#arg-seed"></a></dt>
<dd><p>The seed for random number generation. The default is generated
    from 1 to the maximum integer supported by <span style="R">R</span> on the machine. Even if
    multiple chains are used, only one seed is needed, with other chains having
    seeds derived from that of the first chain to avoid dependent samples.
    When a seed is specified by a number, <code>as.integer</code> will be applied to it.
    If <code>as.integer</code> produces <code>NA</code>, the seed is generated randomly.
    The seed can also be specified as a character string of digits, such as
    <code>"12345"</code>, which is converted to integer.</p></dd>


<dt id="arg-init">init<a class="anchor" aria-label="anchor" href="#arg-init"></a></dt>
<dd><p>Initial values specification. See the detailed documentation for
    the init argument in <code><a href="https://mc-stan.org/rstan/reference/stan.html" class="external-link">stan</a></code>.</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p><code>TRUE</code> or <code>FALSE</code>: flag indicating whether
    to print intermediate output from Stan on the console, which might
    be helpful for model debugging.</p></dd>


<dt id="arg-algorithm">algorithm<a class="anchor" aria-label="anchor" href="#arg-algorithm"></a></dt>
<dd><p>One of sampling algorithms that are implemented in Stan.
    Current options are <code>"NUTS"</code> (No-U-Turn sampler, Hoffman and Gelman 2011, Betancourt 2017),
    <code>"HMC"</code> (static HMC), or <code>"Fixed_param"</code>. The default and
    preferred algorithm is <code>"NUTS"</code>.</p></dd>


<dt id="arg-control">control<a class="anchor" aria-label="anchor" href="#arg-control"></a></dt>
<dd><p>A named <code>list</code> of parameters to control the sampler's
    behavior. See the details in the documentation for the <code>control</code> argument
    in <code><a href="https://mc-stan.org/rstan/reference/stan.html" class="external-link">stan</a></code>.</p></dd>


<dt id="arg-include">include<a class="anchor" aria-label="anchor" href="#arg-include"></a></dt>
<dd><p>Logical scalar defaulting to <code>TRUE</code> indicating
    whether to include or exclude the parameters given by the
    <code>pars</code> argument. If <code>FALSE</code>, only entire multidimensional
    parameters can be excluded, rather than particular elements of them.</p></dd>


<dt id="arg-show-messages">show_messages<a class="anchor" aria-label="anchor" href="#arg-show-messages"></a></dt>
<dd><p>Either a logical scalar (defaulting to <code>TRUE</code>)
    indicating whether to print the summary of Informational Messages to
    the screen after a chain is finished or a character string naming a path
    where the summary is stored. Setting to <code>FALSE</code> is not recommended
    unless you are very sure that the model is correct up to numerical
    error.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional arguments can be <code>chain_id</code>, <code>init_r</code>,
    <code>test_grad</code>, <code>append_samples</code>, <code>refresh</code>,
    <code>enable_random_init</code>. See the documentation in <code><a href="https://mc-stan.org/rstan/reference/stan.html" class="external-link">stan</a></code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>An object of S4 class <code>stanfit</code> representing
   the fitted results. Slot <code>mode</code> for this object
   indicates if the sampling is done or not.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The function has nine available models, which will be fitted according to the
options set in the arguments:</p><ol><li><p>Entry-mean model : fitted when <code>repl = NULL</code>, <code>reg = NULL</code> and <code>year = NULL</code>:
$$y = \mu + g + l + \varepsilon$$
Where \(y\) is the phenotype, \(\mu\) is the intercept, \(g\) is the genotypic
effect, \(l\) is the location (or environment) effect, and \(\varepsilon\) is
the error (which contains the genotype-by-location interaction, in this case).</p></li>
<li><p>Randomized complete blocks design : fitted when <code>repl</code> is a single string.
It will fit different models depending if <code>reg</code> and <code>year</code> are <code>NULL</code>:</p><ul><li><p><code>reg = NULL</code> and <code>year = NULL</code> :
$$y = \mu + g + l + gl + r + \varepsilon$$
where \(gl\) is the genotype-by-location effect, and \(r\) is the replicate effect.</p></li>
<li><p><code>reg = "reg"</code> and <code>year = NULL</code> :
$$y = \mu + g + m + l + gl + gm + r + \varepsilon$$
where \(m\) is the region effect, and \(gm\) is the genotype-by-region effect.</p></li>
<li><p><code>reg = NULL</code> and <code>year = "year"</code> :
$$y = \mu + g + t + l + gl + gt + r + \varepsilon$$
where \(t\) is the year effect, and \(gt\) is the genotype-by-year effect.</p></li>
<li><p><code>reg = "reg"</code> and <code>year = "year"</code> :
$$y = \mu + g + m + t + l + gl + gm + gt + r + \varepsilon$$</p></li>
</ul></li>
<li><p>Incomplete blocks design : fitted when <code>repl</code> is a string vector of size 2.
It will fit different models depending if <code>reg</code> and <code>year</code> are <code>NULL</code>:</p><ul><li><p><code>reg = NULL</code> and <code>year = NULL</code> :
$$y = \mu + g + l + gl + r + b + \varepsilon$$
where \(b\) is the block within replicates effect.</p></li>
<li><p><code>reg = "reg"</code> and <code>year = NULL</code> :
$$y = \mu + g + m + l + gl + gm + r + b + \varepsilon$$</p></li>
<li><p><code>reg = NULL</code> and <code>year = "year"</code> :
$$y = \mu + g + t + l + gl + gt + r + b + \varepsilon$$</p></li>
<li><p><code>reg = "reg"</code> and <code>year = "year"</code> :
$$y = \mu + g + m + t + l + gl + gm + gt + r + b + \varepsilon$$</p></li>
</ul></li>
</ol><p>The models described above have predefined priors:
$$x \sim \mathcal{N} \left( 0, S^{[x]} \right)$$
$$\sigma \sim \mathcal{HalfCauchy}\left( 0, S^{[\sigma]} \right)$$
where \(x\) can be any effect but the error, and \(\sigma\) is the standard
deviation of the likelihood. If <code>res.het = TRUE</code>, then \(\sigma_k \sim \mathcal{HalfCauchy}\left( 0, S^{\left[ \sigma_k \right]} \right)\).
The hyperpriors are set as follows:
$$S^{[x]} \sim \mathcal{HalfCauchy}\left( 0, \phi \right)$$
where \(\phi\) is the known global hyperparameter defined such as \(\phi = max(y) \times 10\).</p>
<p>More details about the usage of <code>bayes_met</code> and other functions of
the <code>ProbBreed</code> package can be found at <a href="https://saulo-chaves.github.io/ProbBreed_site/">https://saulo-chaves.github.io/ProbBreed_site/</a>.
Solutions to convergence or mixing issues can be found at
<a href="https://mc-stan.org/misc/warnings.html" class="external-link">https://mc-stan.org/misc/warnings.html</a>.</p>
    </div>
    <div class="section level2">
    <h2 id="methods">Methods<a class="anchor" aria-label="anchor" href="#methods"></a></h2>


<p></p><dl><dt><code>sampling</code></dt>
<dd><p><code>signature(object = "stanmodel")</code>
      Call a sampler (NUTS, HMC, or Fixed_param depending on parameters)
      to draw samples from the model defined by S4 class <code>stanmodel</code>
      given the data, initial values, etc.</p></dd>


</dl></div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>rstan::sampling, <a href="https://mc-stan.org/rstan/reference/stan.html" class="external-link">rstan::stan</a>, <a href="https://mc-stan.org/rstan/reference/stanfit-class.html" class="external-link">rstan::stanfit</a></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="va">mod</span> <span class="op">=</span> <span class="fu">bayes_met</span><span class="op">(</span>data <span class="op">=</span> <span class="va">maize</span>,</span></span>
<span class="r-in"><span>                gen <span class="op">=</span> <span class="st">"Hybrid"</span>,</span></span>
<span class="r-in"><span>                loc <span class="op">=</span> <span class="st">"Location"</span>,</span></span>
<span class="r-in"><span>                repl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Rep"</span>,<span class="st">"Block"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                trait <span class="op">=</span> <span class="st">"GY"</span>,</span></span>
<span class="r-in"><span>                reg <span class="op">=</span> <span class="st">"Region"</span>,</span></span>
<span class="r-in"><span>                year <span class="op">=</span> <span class="cn">NULL</span>,</span></span>
<span class="r-in"><span>                res.het <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>                iter <span class="op">=</span> <span class="fl">2000</span>, cores <span class="op">=</span> <span class="fl">2</span>, chain <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>               470.301 seconds (Total)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1: </span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>There were 2 divergent transitions after warmup. See</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> to find out why this is a problem and how to eliminate them.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Examine the pairs() plot to diagnose sampling problems</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>The largest R-hat is 1.06, indicating chains have not mixed.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> Running the chains for more iterations may help. See</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> https://mc-stan.org/misc/warnings.html#r-hat</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> Running the chains for more iterations may help. See</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> https://mc-stan.org/misc/warnings.html#bulk-ess</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> Running the chains for more iterations may help. See</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> https://mc-stan.org/misc/warnings.html#tail-ess</span>
<span class="r-in"><span><span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Saulo Chaves, Kaio Dias, Matheus Krause.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

